<template>
  <div class="padding-5">
    <!-- <q-btn color="white" text-color="black" label="Change Modulo 1" @click="updateModulo(0)"/> -->
    <div class="" v-for="index in 28" :key="index">
      <div class="row padding-1" v-if="index % 3 === 0">
        <div class="col">
          <div class="row">
            <div class="col-1 text-center" style="width: 15%">
              {{ index + 1 }}
              <!-- Módulo Número (parte del 0, que es el módulo 1) -->
            </div>
            <div class="col">
              <div class="row">
                <div
                  class="col allCenter"
                  :style="hslInterpolationTEMPERATURA(bms[index+111-1])"
                >
                  {{ bms[index+111-1] }}
                  <!-- Primer Termistor son los pares (0 en a 58) -->
                </div>
                <div
                  class="col allCenter"
                  :style="hslInterpolationTEMPERATURA(bms[index+83-1])"
                >
                  {{ bms[index+83-1] }}
                  <!-- Segundo Termistor son los impares (1 a 59) -->
                </div>
              </div>
              <div
                class="text-center numero"
                :style="rgbInterpolationVOLTAJE(bms[index+55-1])"
              >
                {{ bms[index+55-1] }}
                <!-- Módulo va a la par con el índice -->
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="row">
            <div class="col-1 text-center" style="width: 15%">
              {{ index + 1 + 1 }}
            </div>
            <div class="col">
              <div class="row">
                <div
                  class="col allCenter"
                  :style="
                    hslInterpolationTEMPERATURA(bms[index+111-1+1])
                  "
                >
                  {{ bms[index+111-1+1] }}
                </div>
                <div
                  class="col allCenter"
                  :style="
                    hslInterpolationTEMPERATURA(bms[index+83-1+1])
                  "
                >
                  {{ bms[index+83-1+1] }}
                </div>
              </div>
              <div
                class="text-center numero"
                :style="rgbInterpolationVOLTAJE(bms[index+55-1+1])"
              >
                {{ bms[index+55-1+1] }}
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="row">
            <div class="col-1  text-center" style="width: 15%">
              {{ index + 2 + 1 }}
            </div>
            <div class="col">
              <div class="row">
                <div
                  class="col allCenter"
                  :style="
                    hslInterpolationTEMPERATURA(bms[index+111-1+2])
                  "
                >
                  {{ bms[index+111-1+2] }}
                </div>
                <div
                  class="col allCenter"
                  :style="
                    hslInterpolationTEMPERATURA(bms[index+83-1+2])
                  "
                >
                  {{ bms[index+83-1+2] }}
                </div>
              </div>
              <div
                class="text-center numero"
                :style="rgbInterpolationVOLTAJE(bms[index+55-1+2])"
              >
                {{ bms[index+55-1+2] }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
var rgb2hsl = function (color) {
  var r = color[0] / 255
  var g = color[1] / 255
  var b = color[2] / 255

  var max = Math.max(r, g, b),
    min = Math.min(r, g, b)
  var h,
    s,
    l = (max + min) / 2

  if (max === min) {
    h = s = 0 // achromatic
  } else {
    var d = max - min
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min)
    switch (max) {
      case r:
        h = (g - b) / d + (g < b ? 6 : 0)
        break
      case g:
        h = (b - r) / d + 2
        break
      case b:
        h = (r - g) / d + 4
        break
    }
    h /= 6
  }

  return [h, s, l]
}

function hue2rgb (p, q, t) {
  if (t < 0) t += 1
  if (t > 1) t -= 1
  if (t < 1 / 6) return p + (q - p) * 6 * t
  if (t < 1 / 2) return q
  if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6
  return p
}

var hsl2rgb = function (color) {
  var l = color[2]

  if (color[1] === 0) {
    l = Math.round(l * 255)
    return [l, l, l]
  } else {
    var s = color[1]
    var q = l < 0.5 ? l * (1 + s) : l + s - l * s
    var p = 2 * l - q
    var r = hue2rgb(p, q, color[0] + 1 / 3)
    var g = hue2rgb(p, q, color[0])
    var b = hue2rgb(p, q, color[0] - 1 / 3)
    return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)]
  }
}

var _interpolateHSL = function (color1, color2, factor) {
  if (arguments.length < 3) {
    factor = 0.5
  }
  var hsl1 = rgb2hsl(color1)
  var hsl2 = rgb2hsl(color2)
  for (var i = 0; i < 3; i++) {
    hsl1[i] += factor * (hsl2[i] - hsl1[i])
  }
  return hsl2rgb(hsl1)
}

import { mapState, mapMutations } from 'vuex'

export default {
  name: 'BancoBaterias',
  computed: {
    ...mapState('auriga', ['bms'])
  },
  methods: {
    ...mapMutations('fenix', ['updateModulo']),
    rgbInterpolationVOLTAJE (valor) {
      var maxV = 4.2
      var minV = 3.4
      var factor = (valor - minV) / (maxV - minV) // [3.4, 4.2] -> [0, 1]
      var color1 = [255, 0, 0] // From Red
      var color2 = [0, 255, 0] // To Green
      var colorFinal
      if (valor <= minV) {
        colorFinal = color1
      } else if (valor >= maxV) {
        colorFinal = color2
      } else {
        colorFinal = _interpolateHSL(color1, color2, factor)
      }
      return (
        'background-color: rgb(' +
        colorFinal[0] +
        ',' +
        colorFinal[1] +
        ',' +
        colorFinal[2] +
        ');'
      )
    },
    hslInterpolationTEMPERATURA (valor) {
      var maxT = 50
      var minT = 5
      var factor = (valor - minT) / (maxT - minT)
      var color1 = [0, 150, 255] // From Light Blue
      var color2 = [255, 0, 0] // To Red
      var colorFinal
      if (valor <= minT) {
        colorFinal = color1
      } else if (valor >= maxT) {
        colorFinal = color2
      } else {
        colorFinal = _interpolateHSL(color1, color2, factor)
      }
      return (
        'background-color: rgb(' +
        colorFinal[0] +
        ',' +
        colorFinal[1] +
        ',' +
        colorFinal[2] +
        ');'
      )
    }
  }
}
</script>
